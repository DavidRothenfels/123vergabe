#!/usr/bin/env node

/**
 * Test document creation with new schema
 */

const fetch = require('node-fetch')

async function testDocumentCreation() {
    console.log('🧪 Testing Document Creation')
    console.log('============================')
    
    try {
        // Test creating a document with the new schema
        const testDoc = {
            title: "Test Document",
            content: "This is a test document with the new schema",
            project_id: "test-project-123",
            user_id: "test-user-456", 
            document_type: "leistung",
            type: "leistungsbeschreibung",
            request_id: "test-request-789",
            created_by: "test@example.com",
            generated_by_ai: true
        }
        
        console.log('📤 Creating test document...')
        const response = await fetch('http://localhost:8090/api/collections/documents/records', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testDoc)
        })
        
        if (response.ok) {
            const result = await response.json()
            console.log('✅ Document created successfully!')
            console.log('📋 Document ID:', result.id)
            console.log('📋 Project ID:', result.project_id)
            console.log('📋 User ID:', result.user_id)
            console.log('📋 Document Type:', result.document_type)
            console.log('📋 Generated by AI:', result.generated_by_ai)
            
            // Test filtering by project_id
            console.log('\n🔍 Testing project_id filtering...')
            const filterResponse = await fetch(`http://localhost:8090/api/collections/documents/records?filter=project_id='test-project-123'`)
            
            if (filterResponse.ok) {
                const filterResult = await filterResponse.json()
                console.log('✅ Filter test successful!')
                console.log('📊 Found documents:', filterResult.items.length)
                
                if (filterResult.items.length > 0) {
                    console.log('📋 First document:', {
                        id: filterResult.items[0].id,
                        title: filterResult.items[0].title,
                        project_id: filterResult.items[0].project_id
                    })
                }
            } else {
                console.log('❌ Filter test failed:', filterResponse.status, await filterResponse.text())
            }
            
        } else {
            const error = await response.text()
            console.log('❌ Document creation failed:', response.status)
            console.log('📄 Error response:', error)
        }
        
    } catch (error) {
        console.log('❌ Test failed:', error.message)
    }
    
    console.log('============================')
    console.log('🏁 Test completed')
}

testDocumentCreation()